<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Manage Sensors</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}" />
    <link rel="stylesheet" th:href="@{/css/manageSensors.css}" />
    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>

<!-- Header commun -->
<div th:replace="fragments/header :: appHeader(pageTitle='Manage Sensors', homeUrl=@{/})"></div>

<div class="manageSensors-container" style="width:95%;margin:20px auto;">
    <img src="/image/mantu-logo.jpg" alt="Logo" class="mantu-logo">

    <!-- Filtres -->
    <div class="filters-container"
         style="width: 95%; margin: 20px auto 0 auto; padding: 12px 15px; background-color: white; border: 2px solid #662179; border-radius: 8px; display: flex; gap: 15px; align-items: center; box-sizing: border-box; overflow-x: auto">

        <!-- Date filter -->
        <div style="position: relative; display: flex; align-items: center; width: 180px;">
            <img src="/image/calendar-icon.svg" alt="Calendar Icon"
                 style="position: absolute; left: 10px; width: 18px; height: 18px; pointer-events: none;"/>
            <input type="text" id="dateFilter" title="Filter by commissioning date" placeholder="From date"
                   class="datepicker"
                   style="padding: 8px 30px 8px 36px; border: 1px solid #662179; border-radius: 6px; font-size: inherit; outline: none; box-shadow: none; width: 100%;"/>
            <span id="clearDate"
                  style="position: absolute; right: 8px; cursor: pointer; font-size: 16px; color: #000;">&#10005;</span>
        </div>

        <!-- Status filter -->
        <div style="position: relative; display: flex; align-items: center; width: 160px;">
            <select id="statusFilter" title="Filter by status"
                    style="padding: 8px 30px 8px 12px; border: 1px solid #662179; border-radius: 6px; font-size: inherit; outline: none; box-shadow: none; width: 100%;">
                <option value="" disabled selected hidden>Status (all)</option>
                <option value="true">Active</option>
                <option value="false">Inactive</option>
            </select>
            <span id="clearStatus"
                  style="position: absolute; right: 25px; cursor: pointer; font-size: 16px; color: #000; user-select: none;">&#10005;</span>
        </div>

        <!-- Building filter -->
        <div style="position: relative; display: flex; align-items: center; width: 200px;">
            <select id="buildingFilter" title="Filter by building"
                    style="padding: 8px 30px 8px 12px; border: 1px solid #662179; border-radius: 6px; font-size: inherit; outline: none; box-shadow: none; width: 100%;">
                <option value="" disabled selected hidden>Building (all)</option>
                <option th:each="b : ${buildings}"
                        th:value="${b.id}"
                        th:text="${b.label}">Building</option>
            </select>
            <span id="clearBuilding"
                  style="position: absolute; right: 25px; cursor: pointer; font-size: 16px; color: #000; user-select: none;">&#10005;</span>
        </div>

        <!-- Search input (Sensor ID) -->
        <div style="position: relative; display: flex; align-items: center; width: 220px;">
            <input type="text" id="searchInput" title="Search by Sensor ID"
                   placeholder="Search by Sensor ID"
                   style="padding: 8px 30px 8px 36px; border: 1px solid #662179; font-size: inherit; border-radius: 6px; background: url('/image/search-icon.svg') no-repeat 10px center; background-size: 18px 18px; outline: none; transition: border-color 0.3s ease; width: 100%; box-sizing: border-box;"/>
            <span id="clearSearch"
                  style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 16px; color: #000; user-select: none;">&#10005;</span>
        </div>
    </div>

    <!-- Tableau -->
    <table id="sensorTable">
        <thead>
        <tr>
            <th>Sensor ID</th>
            <th>Device Type</th>
            <th>Commissioning Date</th>
            <th>Status</th>
            <th>Building</th>
            <th>Location</th>
            <th>Gateway ID</th>
            <th>Actions</th>
        </tr>
        </thead>

        <tbody id="sensorTableBody">
        </tbody>
    </table>

    <!-- Pagination -->
    <div id="pagination" class="pagination"></div>

    <!-- ✅ NEW: Popup de confirmation suppression (même logique que gateways) -->
    <div id="deleteSensorPopup" class="modal" style="display:none;">
        <div class="modal-content-delete">
            <h2>Confirm delete?</h2>
            <div th:if="${errorDelete}" class="error-message-delete alert-danger">
                <p th:text="${errorDelete}"></p>
            </div>
            <form th:action="@{/manage-sensors/delete/__id__}" method="post" id="deleteForm">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <div class="form-buttons-delete">
                    <button type="submit">Delete</button>
                    <button type="button" id="closeDelete">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Flatpickr -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<!-- Injection des données côté serveur -->
<script th:inline="javascript">
    /*<![CDATA[*/
      window.SENSORS = [[${sensors}]];
    /*]]>*/
</script>

<!-- JS -->
<script th:src="@{/javascript/manageSensors.js}" defer></script>
</body>
</html>
