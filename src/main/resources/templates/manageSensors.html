<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Manage Sensors</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}"/>
    <link rel="stylesheet" th:href="@{/css/manageSensors.css}"/>
    <!-- Flatpickr CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>

<!-- Header commun -->
<div th:replace="fragments/header :: appHeader(pageTitle='Manage Sensors', homeUrl=@{/})"></div>

<div class="manageSensors-container" style="width:95%;margin:20px auto;">
    <img src="/image/mantu-logo.jpg" alt="Logo" class="mantu-logo">

    <!-- Filtres -->
    <div class="filters-container"
         style="width: 95%; margin: 20px auto 0 auto; padding: 12px 15px; background-color: white; border: 2px solid #662179; border-radius: 8px; display: flex; gap: 15px; align-items: center; box-sizing: border-box; overflow-x: auto">

        <!-- Date filter -->
        <div style="position: relative; display: flex; align-items: center; width: 180px;">
            <img src="/image/calendar-icon.svg" alt="Calendar Icon"
                 style="position: absolute; left: 10px; width: 18px; height: 18px; pointer-events: none;"/>
            <input type="text" id="dateFilter" title="Filter by commissioning date" placeholder="From date"
                   class="datepicker"
                   style="padding: 8px 30px 8px 36px; border: 1px solid #662179; border-radius: 6px; font-size: inherit; outline: none; box-shadow: none; width: 100%;"/>
            <span id="clearDate"
                  style="position: absolute; right: 8px; cursor: pointer; font-size: 16px; color: #000;">&#10005;</span>
        </div>

        <!-- Status filter -->
        <div style="position: relative; display: flex; align-items: center; width: 160px;">
            <select id="statusFilter" title="Filter by status"
                    style="padding: 8px 30px 8px 12px; border: 1px solid #662179; border-radius: 6px; font-size: inherit; outline: none; box-shadow: none; width: 100%;">
                <option value="" disabled selected hidden>Status (all)</option>
                <option value="true">Active</option>
                <option value="false">Inactive</option>
            </select>
            <span id="clearStatus"
                  style="position: absolute; right: 25px; cursor: pointer; font-size: 16px; color: #000; user-select: none;">&#10005;</span>
        </div>

        <!-- Building filter -->
        <div style="position: relative; display: flex; align-items: center; width: 200px;">
            <select id="buildingFilter" title="Filter by building"
                    style="padding: 8px 30px 8px 12px; border: 1px solid #662179; border-radius: 6px; font-size: inherit; outline: none; box-shadow: none; width: 100%;">
                <option value="" disabled selected hidden>Building (all)</option>
                <option th:each="b : ${buildings}"
                        th:value="${b}"
                        th:text="${b}">Building
                </option>
            </select>
            <span id="clearBuilding"
                  style="position: absolute; right: 25px; cursor: pointer; font-size: 16px; color: #000; user-select: none;">&#10005;</span>
        </div>

        <!-- Search input (Sensor ID) -->
        <div style="position: relative; display: flex; align-items: center; width: 220px;">
            <input type="text" id="searchInput" title="Search by Sensor ID"
                   placeholder="Search by Sensor ID"
                   style="padding: 8px 30px 8px 36px; border: 1px solid #662179; font-size: inherit; border-radius: 6px; background: url('/image/search-icon.svg') no-repeat 10px center; background-size: 18px 18px; outline: none; transition: border-color 0.3s ease; width: 100%; box-sizing: border-box;"/>
            <span id="clearSearch"
                  style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 16px; color: #000; user-select: none;">&#10005;</span>
        </div>
    </div>

    <!-- Tableau -->
    <table id="sensorTable">
        <thead>
        <tr>
            <th>Sensor ID</th>
            <th>Device Type</th>
            <th>Commissioning Date</th>
            <th>Status</th>
            <th>Building</th>
            <th>Location</th>
            <th>Gateway ID</th>
            <th>Actions</th>
        </tr>
        </thead>

        <tbody id="sensorTableBody">
        </tbody>
    </table>

    <div id="pagination" class="pagination"></div>

    <button id="openCreateBtn">Add Sensor</button>

    <!-- Formulaire pour ajouter un Sensor -->
    <div id="createSensorPopup" class="modal modalCreate" style="display:none;">
        <div class="modal-content">
            <h2>Add Sensor</h2>

            <!-- Affichage d'une erreur serveur éventuelle -->
            <div th:if="${errorAdd}" class="error-message-create alert-danger">
                <p th:text="${errorAdd}"></p>
            </div>

            <form id="createForm" th:action="@{/manage-sensors/add}" th:object="${sensorAdd}" method="post">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                <!-- Sensor ID -->
                <input type="text"
                       th:field="*{idSensor}"
                       placeholder="Sensor ID"
                       required
                       pattern="^[a-z0-9](?:[-]?[a-z0-9]){2,}$"
                       oninput="this.value=this.value.toLowerCase()"
                       th:classappend="${#fields.hasErrors('idSensor')} ? 'input-error' : ''"/>
                <div class="field-error" th:if="${#fields.hasErrors('idSensor')}" th:errors="*{idSensor}"></div>

                <!-- Device Type -->
                <input type="text" th:field="*{deviceType}" placeholder="Device Type" required
                       th:classappend="${#fields.hasErrors('deviceType')} ? 'input-error' : ''"/>
                <div class="field-error" th:if="${#fields.hasErrors('deviceType')}" th:errors="*{deviceType}"></div>

                <!-- Commissioning Date (optionnel) -->
                <input type="text" id="commissioningDateInput" th:field="*{commissioningDate}"
                       placeholder="Commissioning Date (optional)" class="datepicker"
                       th:classappend="${#fields.hasErrors('commissioningDate')} ? 'input-error' : ''"/>
                <div class="field-error" th:if="${#fields.hasErrors('commissioningDate')}" th:errors="*{commissioningDate}"></div>

                <!-- Status (optionnel) -->
                <select th:field="*{status}" th:classappend="${#fields.hasErrors('status')} ? 'input-error' : ''">
                    <option value="" selected>Status (optional)</option>
                    <option th:value="true">Active</option>
                    <option th:value="false">Inactive</option>
                </select>
                <div class="field-error" th:if="${#fields.hasErrors('status')}" th:errors="*{status}"></div>

                <!-- ====== BLOC DÉPENDANT DE LA GATEWAY (regroupé) ====== -->

                <!-- Gateway ID (porte aussi freq & building en data-attrs) -->
                <select id="gatewaySelect" th:field="*{idGateway}" required
                        th:classappend="${#fields.hasErrors('idGateway')} ? 'input-error' : ''">
                    <option value="" disabled selected>Select a Gateway</option>
                    <option th:each="g : ${gateways}"
                            th:value="${g.gatewayId}"
                            th:text="${g.gatewayId}"
                            th:attr="data-freq=${g.frequencyPlan},data-building=${g.buildingName}">
                        GATEWAY_ID
                    </option>
                </select>
                <div class="field-error" th:if="${#fields.hasErrors('idGateway')}" th:errors="*{idGateway}"></div>

                <!-- Frequency Plan (auto depuis gateway, éditable) -->
                <input type="text" id="frequencyPlanInput" th:field="*{frequencyPlan}" placeholder="Frequency Plan"
                       th:classappend="${#fields.hasErrors('frequencyPlan')} ? 'input-error' : ''"/>
                <div class="field-error" th:if="${#fields.hasErrors('frequencyPlan')}" th:errors="*{frequencyPlan}"></div>

                <!-- Building Name (auto-rempli depuis la Gateway) -->
                <input type="text" id="buildingNameInput" th:field="*{buildingName}" placeholder="Building Name"
                       list="buildingsOptions" required
                       th:classappend="${#fields.hasErrors('buildingName')} ? 'input-error' : ''"/>
                <div class="field-error" th:if="${#fields.hasErrors('buildingName')}" th:errors="*{buildingName}"></div>

                <datalist id="buildingsOptions">
                    <option th:each="b : ${buildings}" th:value="${b}" th:text="${b}">Building</option>
                </datalist>

                <!-- ====== FIN DU BLOC DÉPENDANT DE LA GATEWAY ====== -->

                <!-- Floor -->
                <input type="number" th:field="*{floor}" placeholder="Floor" required
                       th:classappend="${#fields.hasErrors('floor')} ? 'input-error' : ''"/>
                <div class="field-error" th:if="${#fields.hasErrors('floor')}" th:errors="*{floor}"></div>

                <!-- Location (optionnel) -->
                <input type="text" th:field="*{location}" placeholder="Location"
                       th:classappend="${#fields.hasErrors('location')} ? 'input-error' : ''"/>
                <div class="field-error" th:if="${#fields.hasErrors('location')}" th:errors="*{location}"></div>

                <!-- DevEUI -->
                <input type="text" id="devEuiInput" th:field="*{devEui}" placeholder="DevEUI" required
                       pattern="^[A-Fa-f0-9]{16}$" title="16 hex characters (0-9, A-F)"
                       th:classappend="${#fields.hasErrors('devEui')} ? 'input-error' : ''"/>
                <div class="field-error" th:if="${#fields.hasErrors('devEui')}" th:errors="*{devEui}"></div>

                <!-- JoinEUI -->
                <input type="text" id="joinEuiInput" th:field="*{joinEui}" placeholder="JoinEUI" required
                       pattern="^[A-Fa-f0-9]{16}$" title="16 hex characters (0-9, A-F)"
                       th:classappend="${#fields.hasErrors('joinEui')} ? 'input-error' : ''"/>
                <div class="field-error" th:if="${#fields.hasErrors('joinEui')}" th:errors="*{joinEui}"></div>

                <!-- AppKey -->
                <input type="password" id="appKeyInput" th:field="*{appKey}" placeholder="AppKey" required
                       pattern="^[A-Fa-f0-9]{32}$" title="32 hex characters (0-9, A-F)"
                       th:classappend="${#fields.hasErrors('appKey')} ? 'input-error' : ''"/>
                <div class="field-error" th:if="${#fields.hasErrors('appKey')}" th:errors="*{appKey}"></div>

                <div class="form-buttons">
                    <button type="submit">Add</button>
                    <button type="button" id="closeCreateSensor">Cancel</button>
                </div>
            </form>

        </div>
    </div>

    <!-- Formulaire pour éditer un Sensor -->
    <div id="editSensorPopup" class="modal" th:if="${sensorEdit != null}">
        <div class="modal-content">
            <h2>Edit Sensor</h2>

            <div th:if="${errorEdit}" class="error-message-edit alert-danger">
                <p th:text="${errorEdit}"></p>
            </div>

            <form id="editForm" th:action="@{/manage-sensors/edit}" th:object="${sensorEdit}" method="post">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                <!-- ID obligatoire (hidden) -->
                <input type="hidden" th:field="*{idSensor}"/>

                <!-- Champs éditables -->
                <input type="text" th:field="*{deviceType}" placeholder="Device Type" required/>
                <input type="text" class="datepicker" th:field="*{commissioningDate}" placeholder="Commissioning Date"/>
                <input type="number" th:field="*{floor}" placeholder="Floor" required/>
                <input type="text" th:field="*{location}" placeholder="Location"/>

                <div class="form-buttons">
                    <button type="submit">Update</button>
                    <button type="button" id="closeEditSensor">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Popup de confirmation suppression -->
    <div id="deleteSensorPopup" class="modal" style="display:none;">
        <div class="modal-content-delete">
            <h2>Confirm delete?</h2>
            <div th:if="${errorDelete}" class="error-message-delete alert-danger">
                <p th:text="${errorDelete}"></p>
            </div>
            <form th:action="@{/manage-sensors/delete/__id__}" method="post" id="deleteForm">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <div class="form-buttons-delete">
                    <button type="submit">Delete</button>
                    <button type="button" id="closeDelete">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Flatpickr -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script th:inline="javascript">
    /*<![CDATA[*/
    window.SENSORS  = [[${sensors}]];
    window.GATEWAYS = [[${gateways}]];
    /*]]>*/
</script>

<!-- JS -->
<script th:src="@{/javascript/manageSensors.js}" defer></script>
</body>
</html>
