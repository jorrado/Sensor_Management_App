<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <title>Gateway Monitoring</title>
    <link rel="stylesheet" type="text/css" th:href="@{/css/styles.css}"/>
    <link rel="stylesheet" href="/css/monitoringGateway.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.5.0/dist/chart.umd.min.js"></script>
</head>

<body>

<header th:inline="text">--[[${gatewayName}]]</header>
<main>
    <section class="info-grid">
        <div class="card">
            <h4>Status</h4>
            <p><span id="gateway-status-badge" class="badge"><img src="/image/toggle_on.svg" alt="Status"/>--</span></p>
        </div>
        <div class="card"><h4>CPU Température</h4>
            <p><span id="cpu-temp-badge" class="badge"><img src="/image/thermostat.svg" alt="Temp"/><span id="cpu-temp">--</span></span></p>
        </div>
        <div class="card"><h4>Number of sensors connected</h4>
            <p><span id="num-sensors-badge" class="badge"><img src="/image/sensor-icon.svg" alt="Sensors"/>--</span></p>
        </div>
        <div class="card"><h4>Gateway ID</h4>
            <p id="gateway-id">--</p>
        </div>
        <div class="card"><h4>Created at</h4>
            <p id="createdAt">--</p>
        </div>
        <div class="card"><h4>Uptime Days</h4>
            <p id="uptimeDays">--</p>
        </div>
        <div class="card"><h4>IP Locale</h4>
            <p id="ipLocal">--</p>
        </div>
        <div class="card"><h4>IP Publique</h4>
            <p id="ipPublic">--</p>
        </div>
        <!--            <div class="card"><h4>Location</h4><p>Bât A - Étage 2</p></div>-->
        <!--            <div class="card"><h4>Location</h4><p id="gateway-location">&#45;&#45;</p></div>-->
        <!--            <div class="card"><h4>Hard drive</h4><p id="hardDrive">&#45;&#45;</p></div>-->
    </section>

    <section class="chart-grid">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h4>RAM Usage</h4>
                <h4 id="ramTotal" style="font-weight:normal;">--</h4>
            </div>
            <canvas id="ramChart"></canvas>
        </div>
        <div class="card">
            <h4>CPU Usage</h4>
            <canvas id="cpuChart"></canvas>
        </div>
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h4>Hard drive Usage</h4>
                <h4 id="hardDrive" style="font-weight:normal;">--</h4>
            </div>
            <canvas id="harddriveChart"></canvas>
        </div>
    </section>

    <section id="dashboard" style="display: flex; gap: 20px;">
        <div id="sensorsTable" style="flex: 1;">
            <div class="card">
                <h4>Connected Sensors</h4>
                <div class="table-container">
                    <table>
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Application</th>
                            <th>Status</th>
                        </tr>
                        </thead>
                        <tbody id="sensors-tbody">
                        <!-- tableau dynamique de capteurs -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="card" id="mapContainer" style="flex: 1; padding: 10px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h4>Gateway Location</h4>
                <h4 id="gateway-location" style="font-weight:normal;">--</h4>
            </div>
            <br>
            <div id="map" style="min-height:300px; height:50vh; width:100%; border-radius:10px;"></div>
        </div>
    </section>

    <div style="margin-top:20px;">
        <a href="/manage-gateways" class="btn">← Back to list</a>
    </div>
</main>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="/javascript/monitoringGateway.js"></script>
<script th:inline="javascript">
    const gatewayId = /*[[${gatewayId}]]*/ null;
    const gatewayIp = /*[[${ipAddress}]]*/ null;

    const eventSource = new EventSource(
        `/manage-gateways/monitoring/${encodeURIComponent(gatewayId)}/stream?ip=${encodeURIComponent(gatewayIp)}&t=${Date.now()}`
    );

    eventSource.onmessage = function(event) {
        const data = JSON.parse(event.data);

        if (data.gateway_info && data.gateway_info.name) {
            document.querySelector("header").textContent = data.gateway_info.name;
        }

        const statusBadge = document.querySelector("#gateway-status-badge");
        if (statusBadge && data.system.gateway_status) {
            statusBadge.textContent = data.system.gateway_status.charAt(0).toUpperCase() + data.system.gateway_status.slice(1);

            let imgSrc = "/image/toggle_off.svg";
            let bgColor = "red";
            if (data.system.gateway_status.toLowerCase() === "activating" || data.system.gateway_status.toLowerCase() === "active") {
                imgSrc = "/image/toggle_on.svg";
                bgColor = "green";
            }
            statusBadge.innerHTML = `<img src="${imgSrc}" alt="Status" /> ${statusBadge.textContent}`;
            statusBadge.style.backgroundColor = bgColor;
        }

        document.querySelector("#cpu-temp").textContent = `${data.system['cpu_temp (C)']} °C`;

        const sensorsBadge = document.querySelector("#num-sensors-badge");
        if (sensorsBadge && data.devices) {
            const count = data.devices.length;
            sensorsBadge.innerHTML = `<img src="/image/sensor-icon.svg" alt="Sensors" />${count}`;
            sensorsBadge.style.backgroundColor = count > 0 ? 'green' : 'gray';
        }

        if (document.querySelector("#gateway-id").textContent === "--") {
            document.querySelector("#gateway-id").textContent = gatewayId;
        }

        if (document.querySelector("#createdAt").textContent === "--" &&
            data && data.gateway_info && data.gateway_info.created_at) {
            const createdAt = data.gateway_info.created_at.split('T')[0];
            document.querySelector("#createdAt").textContent = createdAt;
        }

        if (document.querySelector("#uptimeDays").textContent === "--" && data.system.uptime_days) {
            document.querySelector("#uptimeDays").textContent = data.system.uptime_days;
        }

        if (document.querySelector("#ipLocal").textContent === "--" && data.system.ip_local) {
            document.querySelector("#ipLocal").textContent = data.system.ip_local;
        }

        if (document.querySelector("#ipPublic").textContent === "--" && data.system.ip_public) {
            document.querySelector("#ipPublic").textContent = data.system.ip_public;
        }

        const locationElem = document.querySelector("#gateway-location");
        if (locationElem && data.database && data.database.location) {
            locationElem.innerHTML = `<strong style="font-family: inherit; font-weight: bold;">${data.database.location}</strong>`;
        }

        const ramTotal = data.system['ram_total_gb (GB)'];
        const ramUsed = data.system['ram_used_gb (GB)'];
        if (ramTotal && ramUsed) {
            const ramUsagePercent = (ramUsed / ramTotal) * 100;
            ramChart.data.datasets[0].data.push(ramUsagePercent);
            if (ramChart.data.datasets[0].data.length > 5) {
                ramChart.data.datasets[0].data.shift();
                ramChart.data.labels.shift();
            }
            const now = new Date();
            ramChart.data.labels.push(now.getHours() + ':' + now.getMinutes().toString().padStart(2, '0'));
            ramChart.update();
        }

        const cpuUsage = data.system['cpu_percent (%)'];
        if (cpuUsage !== undefined) {
            cpuChart.data.datasets[0].data.push(cpuUsage);
            if (cpuChart.data.datasets[0].data.length > 30) {
                cpuChart.data.datasets[0].data.shift();
                cpuChart.data.labels.shift();
            }
            const now = new Date();
            cpuChart.data.labels.push(now.getHours() + ':' + now.getMinutes().toString().padStart(2, '0'));
            cpuChart.update();
        }

        const diskUsedPercentRaw = data.system['disk_usage_percent'];
        const diskUsedPercent = diskUsedPercentRaw ? parseFloat(diskUsedPercentRaw.replace('%', '')) : undefined;
        if (diskUsedPercent !== undefined) {
            harddriveChart.data.datasets[0].data.push(diskUsedPercent);
            if (harddriveChart.data.datasets[0].data.length > 30) {
                harddriveChart.data.datasets[0].data.shift();
                harddriveChart.data.labels.shift();
            }
            const now = new Date();
            harddriveChart.data.labels.push(now.getHours() + ':' + now.getMinutes().toString().padStart(2, '0'));
            harddriveChart.update();
        }

        if (document.querySelector("#ramTotal").textContent === "--" && data.system['ram_total_gb (GB)']) {
            const ramTotalNumber = parseFloat(data.system['ram_total_gb (GB)']);
            document.querySelector("#ramTotal").innerHTML = `<strong style="font-family: inherit; font-weight: bold;">${ramTotalNumber.toFixed(2)} GB</strong>`;
        }

        if (document.querySelector("#hardDrive").textContent === "--" && data.system.disk_total) {
            const diskTotalNumber = parseFloat(data.system.disk_total);
            document.querySelector("#hardDrive").innerHTML = `<strong style="font-family: inherit; font-weight: bold;">${diskTotalNumber.toFixed(2)} GB</strong>`;
        }

        const cpuTempBadge = document.querySelector("#cpu-temp-badge");
        if (cpuTempBadge) {
            const cpuTemp = data.system['cpu_temp (C)'];
            cpuTempBadge.style.backgroundColor =
                cpuTemp <= 75 ? 'green' : (cpuTemp <= 85 ? 'orange' : 'red');
        }

        const tbody = document.querySelector("#sensors-tbody");
        if (tbody && data.devices) {
            tbody.innerHTML = "";
            data.devices.forEach(device => {
                const statusOn = true; // à remplacer si tu as un vrai champ status
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${device.device_id}</td>
                    <td>${device.application_id}</td>
                    <td>
                        <span class="badge badge-small" style="background-color:${statusOn ? 'green' : 'red'}">
                            <img src="/image/${statusOn ? 'toggle_on' : 'toggle_off'}.svg" alt="${statusOn ? 'On' : 'Off'}" />
                            ${statusOn ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        if (data.gateway_info && data.gateway_info.location && typeof gatewayMarker !== 'undefined') {
            const lat = data.gateway_info.location.latitude;
            const lon = data.gateway_info.location.longitude;
            gatewayMarker.setLatLng([lat, lon]);
            if (typeof map !== 'undefined') {
                map.setView([lat, lon], 13);
            }
        }

        console.log("Data reçue :", data);
    };

    eventSource.onerror = function(error) {
        console.error("Erreur SSE :", error);
        eventSource.close();
    };
</script>

</body>
</html>
